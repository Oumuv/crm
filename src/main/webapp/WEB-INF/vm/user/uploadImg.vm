<link href="#springUrl('/css/cropper.css')" rel="stylesheet">
<link href="#springUrl('/css/main.css')" rel="stylesheet">
<style>
</style>
<body>
	<div class="container" id="crop-avatar">


		<!-- Cropping modal -->
		<div class="modal fade" id="avatar-modal" aria-hidden="true"
			aria-labelledby="avatar-modal-label" role="dialog" tabindex="-1">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<form class="avatar-form" action=""
						enctype="multipart/form-data">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal">&times;</button>
							<h4 class="modal-title" id="avatar-modal-label">#springUrl(${user.himg})Change
								Avatar</h4>
						</div>
						<div class="modal-body">
							<div class="avatar-body">

								<!-- Upload image and data -->
								<div class="avatar-upload">
									<input type="hidden" class="avatar-src" name="avatar_src">
									<input type="hidden" class="avatar-data" name="avatar_data">
									<label for="avatarInput">Local upload</label> <input
										type="file" class="avatar-input" id="avatarInput"
										name="avatar_file">
								</div>

								<!-- Crop and preview -->
								<div class="row">
									<div class="col-md-9">
										<div class="avatar-wrapper">
											<img id='image' src="">
										</div>
									</div>
									<div class="col-md-3">
										<div class="avatar-preview preview-lg img-preview"></div>
										<div class="avatar-preview preview-md img-preview"></div>
										<div class="avatar-preview preview-sm img-preview"></div>
									</div>
								</div>

								<div class="row avatar-btns">
									<div class="col-md-9">
										<div class="btn-group">
											<button type="button" class="btn btn-primary"
												data-method="rotate" data-option="-90"
												title="Rotate -90 degrees">Rotate Left</button>
											<button type="button" class="btn btn-primary"
												data-method="rotate" data-option="-15">-15deg</button>
											<button type="button" class="btn btn-primary"
												data-method="rotate" data-option="-30">-30deg</button>
											<button type="button" class="btn btn-primary"
												data-method="rotate" data-option="-45">-45deg</button>
										</div>
										<div class="btn-group">
											<button type="button" class="btn btn-primary"
												data-method="rotate" data-option="90"
												title="Rotate 90 degrees">Rotate Right</button>
											<button type="button" class="btn btn-primary"
												data-method="rotate" data-option="15">15deg</button>
											<button type="button" class="btn btn-primary"
												data-method="rotate" data-option="30">30deg</button>
											<button type="button" class="btn btn-primary"
												data-method="rotate" data-option="45">45deg</button>
										</div>
									</div>
									<div class="col-md-3">
										<span 
											class="btn btn-primary btn-block avatar-save">Done</span>
									</div>
								</div>
							</div>
						</div>
						<!-- <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div> -->
					</form>
				</div>
			</div>
		</div>
		<!-- /.modal -->

		<!-- Loading state -->
		<div class="loading" aria-label="Loading" role="img" tabindex="-1"></div>
	</div>

	<script src="#springUrl('/js/cropper.js')"></script>
	<!-- <script src="springUrl('/js/main.js')"></script> -->
	<script>
		$(function() {
			$('#avatar-modal').modal('show');
			// Import image
			var $inputImage = $('#avatarInput');
			var $image = $('#image');
			var URL = window.URL || window.webkitURL;
			console.log("URL:" + URL);
			var options = {
				aspectRatio : 1 / 1,
				preview : '.img-preview',
				crop : function(e) {
				}
			};
			$('#image').on({
			    ready: function (e) {
			        console.log(e.type);
			      },
			      cropstart: function (e) {
			        console.log(e.type, e.action);
			      },
			      cropmove: function (e) {
			        console.log(e.type, e.action);
			      },
			      cropend: function (e) {
			        console.log(e.type, e.action);
			      },
			      crop: function (e) {
			        console.log(e.type, e.x, e.y, e.width, e.height, e.rotate, e.scaleX, e.scaleY);
			      },
			      zoom: function (e) {
			        console.log(e.type, e.ratio);
			      }
			    }).cropper(options);
			
			$('#avatarInput').change(function() {
				var imgFile = this.files[0];
				var reader = new FileReader();

				reader.onloadstart = function(e) {
					console.log("开始读取....");
				}
				reader.onprogress = function(e) {
					console.log("正在读取中....");
				}
				reader.onabort = function(e) {
					console.log("中断读取....");
				}
				reader.onerror = function(e) {
					console.log("读取异常....");
				}
				reader.onload = function(e) {

// 					$('#image').src = e.target.result;
					$('#image').cropper('destroy').attr('src', e.target.result).cropper(options);
					console.log("成功读取....");
				}
				reader.readAsDataURL(imgFile);
			});
		})
		
		$('.avatar-save').click(function() {
			if (confirm("确认修改信息？")) {
				var params = $(".avatar-form").serialize();
				$.ajax({
					type : "POST",
					url : "#springUrl('/user/uploadImg2.do')",
					data : params,
					success : function(msg) {
						alert( msg);
// 						$('#myModal').empty();
// 						$('#myModal').modal('hide');
					},
					error:function(msg){
						if(confirm("修改失败,是否查看错误详细信息？")){
							alert(msg)
							console.log(msg)
						}
					}
				});
			}
		})
	</script>
</body>